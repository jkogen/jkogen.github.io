<html data-bs-theme="dark">

    <head>
        <script src="https://momentjs.com/downloads/moment.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1"></script>

        <script type="text/javascript">
            class WuerfelErgebnis {
                constructor(datum, zeit, scramble) {
                    this.datum = new Date(datum.replace(' ', 'T'));
                    this.zeitInSekkunden = getZeitInSekunden(zeit);
                    this.scramble = scramble;
                    this.kw = getKalenderwoche(this.datum);

                    //Man muss dne Monat anhand der KW beziehen, ansonsten ziehen sich die KWs teils √ºber zwei Monate
                    this.monatsbezeichnung = getMonthFromWeek(this.kw, this.datum.getFullYear());
                    this.jahrMonatKw = this.datum.getFullYear() + "\r\nKW" +  this.kw + "\r\n" + this.monatsbezeichnung;
                }
            }

            var wuerfelErgebnisse = [];                
            let delayed;

            function readFile() {
                //todo
                //const initFile = document.getElementById("initFile").files[0];
                //dateiAuslesen(initFile);
                const myFile = document.getElementById("dateiEingabe").files[0];
                dateiAuslesen(myFile);
            }

            function dateiAuslesen(dateiName) {
                const reader = new FileReader();
                reader.readAsText(dateiName);

                //erst ausgeben wenn der reader zu ende ist (async)
                reader.onload = function(e) {

                    var lineNumber = 0;
                    const splittedResults = reader.result.split("\r\n");
                    splittedResults.forEach(line => {

                        lineNumber++;

                        //Die ersten beiden Zeilen sind header
                        if(lineNumber < 3) {
                            return;
                        }

                        var splittedLine = line.split("	");

                        if(splittedLine.length < 4) {
                            return;
                        }

                        var datum = splittedLine[0];
                        var zeit = splittedLine[1];
                        var scramble = splittedLine[4];
                        wuerfelErgebnisse.push(new WuerfelErgebnis(datum, zeit, scramble))
                    });

                    //todo wieder nach oben
                    document.getElementById("divErgebnisse").style.display="block";
                    document.getElementById("labelInsgesamteAnzahl").innerHTML = wuerfelErgebnisse.length + " x";
                    document.getElementById("labelMedianInsgesamt").innerHTML = medianBerechnen(wuerfelErgebnisse) + " Sekunden";
                    var bestesErgebnis = bestZeitErmitteln(wuerfelErgebnisse);
                    document.getElementById("bestZeit").innerHTML = bestesErgebnis.zeitInSekkunden + " Sekunden";
                    document.getElementById("bestZeitTag").innerHTML = " und war am " + new moment(bestesErgebnis.datum).format('DD.MM.yyyy') + ". Du Tiger! üêØ";

                    streuungAuswerten();
                    anzahlAuswerten();
                }
            }

            function bestZeitErmitteln(daten) {
                var bestZeit = daten[0];

                daten.forEach(a => {
                    if(bestZeit.zeitInSekkunden > a.zeitInSekkunden)  {
                        bestZeit = a;
                    }
                });

                return bestZeit;
            }

            //todo moments verwenden
            function getZeitInSekunden(zeitString) {
                if(zeitString.includes(':')) {
                    //Format MM:SS.ms
                    const [min, sek] = zeitString.split(":");
                    return parseFloat(min) * 60 + parseFloat(sek);
                } else {
                    return parseFloat(zeitString);
                }
            }

            function medianBerechnen(daten) {
                var sortierteSekkunden = daten.map(obj => obj.zeitInSekkunden).sort((a, b) => a - b);
                const mitte = sortierteSekkunden.length % 2 == 0 ?  sortierteSekkunden.length / 2 : ( sortierteSekkunden.length + 1) / 2;
                return sortierteSekkunden[mitte];
            }

            function anzahlAuswerten(){
                var anzahlJeKw = wuerfelErgebnisse.reduce((accumulator, wuerfelErgebnis) => {
                    
                    var jahr = wuerfelErgebnis.jahrMonatKw.split("\r\n")[0];
                    var kwSplit = wuerfelErgebnis.jahrMonatKw.split("\r\n")[1].split("KW")[1];
                    var key = moment().year(jahr).isoWeek(kwSplit).isoWeekday(1).format('YYYY-MM-DD');
                    accumulator[key] = (accumulator[key] || 0) + 1;
                    return accumulator;
                }, {});

                var durchschnittJeTag = [];

                // Object.keys(anzahlJeKw).forEach(a =>  {
                //     anzahlJeKw[a] = anzahlJeKw[a] / 7;

                //     durchschnittJeTag.push(anzahlJeKw);
                // });

                var anzahljeTag = wuerfelErgebnisse.reduce((accumulator, wuerfelErgebnis) => {
                    var key = moment(wuerfelErgebnis.datum).format('YYYY-MM-DD');
                    accumulator[key] = (accumulator[key] || 0) + 1;
                    return accumulator;
                }, {});

                const ctx = document.getElementById('diagramAnzahlJeKw').getContext('2d');

                new Chart(ctx, {
                    data: {
                        datasets: [{
                                type: 'bar',
                                data: anzahljeTag,
                                label: 'Anzahl je Tag',
                                // backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                // hoverBackgroundColor: '#3366FF',
                                // borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                borderRadius: 3
                            }
                        //     ,{
                        //     type: 'line',
                        //     label: 'Anzahl pro Kalenderwoche',
                        //     data: durchschnittJeTag // Werte als y-Achse: [57, 120, 160, 6]
                        // }
                    ]
                    },
                    options: {
                        scales: {
                        x: {
                            type: 'time',
                            distribution: 'series',  // Stellt sicher, dass nur Datumsangaben mit Daten skaliert werden
                            time: {
                            unit: 'day',
                            tooltipFormat: 'DD.MM.YYYY',
                                displayFormats: {
                                    day: 'DD.MM.yyyy'
                                }
                            },
                        }
                        }, 
                        animation: {
                            onComplete: () => {
                                delayed = true;
                            },
                            delay: (context)=> {
                                let delay = 0;
                                if(context.type === 'data' && context.mode === 'default' && !delayed) {
                                    delay = context.dataIndex * 100 + context.datasetIndex * 200;
                                }
                                return delay;
                            },
                        }
                    }
                });
            }

            function streuungAuswerten() {
                const canvasZweiDContext = document.getElementById('diagrammStreuung').getContext('2d');
                const streuWerte =  wuerfelErgebnisse.map(item => ({
                    x: new Date(item.datum),
                    y: item.zeitInSekkunden
                }));


                var gruppierteDaten = wuerfelErgebnisse.reduce((accu, obj) => {
                    //todo moments
                    const key = obj.datum.toISOString().split('T')[0];
                    //const key = obj.datum;

                    if(!accu[key]) {
                        accu[key] = [];
                    }

                    accu[key].push(obj);
                    return accu;
                }, []);

                var mediansJeTag = [];

                Object.keys(gruppierteDaten).forEach(datum => {
                    var medianAmTag = medianBerechnen(gruppierteDaten[datum]);
                    mediansJeTag.push({
                        x: datum,
                        y: medianAmTag
                    });
                    //mediansJeTag[datum] = medianAmTag;
                });

                const gruppiertNachKw = wuerfelErgebnisse.reduce((accumulator, wuerfelErgebnis) => {
                    const kkey = wuerfelErgebnis.jahrMonatKw;

                    //Schluessel erstellen, damit im Nachhinein auch erstmalig ein Objekt dazu gezwischtert werden kann
                    if(!accumulator[kkey]) {
                        accumulator[kkey] = []
                    }

                    accumulator[kkey].push(wuerfelErgebnis);

                    return accumulator;
                }, []);

                var mediansJeKw = [];

                Object.keys(gruppiertNachKw).forEach(kw => {
                    var medianErgebnis = medianBerechnen(gruppiertNachKw[kw]);
                    var jahr = kw.split("\r\n")[0];
                    var kwSplit = kw.split("\r\n")[1].split("KW")[1];
                    var key = moment().year(jahr).isoWeek(kwSplit).isoWeekday(1).format('YYYY-MM-DD');
                    mediansJeKw.push({
                        x: key,
                        y: medianErgebnis
                    });
                });

                new Chart(canvasZweiDContext, {
                    
                    data: {
                        datasets: [ {                        
                            type: 'line',
                            data: mediansJeKw,
                            label: 'Wochenmedian',
                            borderColor: 'rgba(255, 193, 7, 0.9)',
                            backgroundColor: 'rgba(255, 113, 67, 0.7)',
                            fill: false // sonst w√ºrden das chart zum scatter mutieren
                        }, {
                            type: 'line',
                            data: mediansJeTag,
                            label: 'Tagesmedian',
                            borderColor: 'rgba(0, 123, 255, 0.6)',
                            backgroundColor: 'rgba(0, 123, 255, 0.6)',
                            fill: false // sonst w√ºrden das chart zum scatter mutieren
                        },{
                            type: 'scatter',
                            data: streuWerte,
                            label: 'Tageswerte',
                            backgroundColor: 'rgba(90, 47, 49, 0.6)'
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                distribution: 'series',  // Stellt sicher, dass nur Datumsangaben mit Daten skaliert werden
                                time: {
                                unit: 'day',
                                tooltipFormat: 'DD.MM.YYYY',
                                    displayFormats: {
                                        day: 'DD.MM.yyyy'
                                    }
                                },
                            }
                        },
                        animation: {
                            onComplete: () => {
                                delayed = true;
                            },
                            delay: (context)=> {
                                let delay = 0;
                                if(context.type === 'data' && context.mode === 'default' && !delayed) {
                                    delay = context.dataIndex * 5 + context.datasetIndex * 5;
                                }
                                return delay;
                            },
                        }
                    }
                });
            }

            //todo moments
            function getMonatsbezeichnung(datum) {
                return new Intl.DateTimeFormat('de-DE', {month: 'long'}).format(datum);
            }

            //todo moments
            function getKalenderwoche(datum){
                const d=new Date(datum);
                const januar = new Date(d.getFullYear(), 0, 1);
                const tageSeitJanuar = Math.floor((d - januar) / (24 * 60 * 60 * 1000));
                var kw = Math.ceil((tageSeitJanuar + januar.getDate() + 1) / 7);
                return kw;
            }

            //todo moments
            function getMonthFromWeek(week, year) {
                // Erster Tag des Jahres
                const firstDayOfYear = new Date(year, 0, 1);
                // Wochentag des 1. Januar (0 = Sonntag, 1 = Montag, ..., 6 = Samstag)
                const dayOfWeek = firstDayOfYear.getDay();

                // Berechne den ersten Montag des Jahres
                const daysUntilMonday = (1 - dayOfWeek + 7) % 7;
                const firstMonday = new Date(firstDayOfYear);
                firstMonday.setDate(firstDayOfYear.getDate() + daysUntilMonday);

                // Berechne den Montag der gew√ºnschten Kalenderwoche
                const mondayOfWeek = new Date(firstMonday);
                mondayOfWeek.setDate(firstMonday.getDate() + (week - 1) * 7);

                // Monat aus dem Datum extrahieren (0-basiert, daher +1)
                const month = mondayOfWeek.getMonth() + 1;
                const dateWithMonth = new Date(year, month, 1);
                return new Intl.DateTimeFormat('de-DE', {month: 'long'}).format(dateWithMonth);
            }
        </script>

        <style>
            body {
                padding: 50px;
                background: black;
            }

        </style>
    </head>

    <body style="text-align:center">
        <div class="container">
            <div class="row">
                <div class="col">
                    <img src="cube.jpg" height="250px" style="border-radius: 20px"/>
                    <br />
                    <br />
                    <h1>Cube-Statistikboss</h1>
                    <hr>
                    <p>
                        Hier kannst du deine Cube-Files analysieren lassen
                        <br />
                        <br />
                        <input type="file" id="initFile" value="init.csv" style="display:none" />
                        <input class="form-control w-50 mx-auto" type="file" id="dateiEingabe" text="Upload .csv!" onchange="readFile()">
                        <br />
                        <br />
                    </p>
                </div>
            </div>
            <div id="divErgebnisse" style="display:none">
                <div class="row">
                    <label>Deine beste Zeit ist </label>
                    <label id="bestZeit" style="font-size:xx-large;font-weight:900;color:darkgreen;">x Sekunden</label>
                    <label id="bestZeitTag">und war am  dd.MM.yyyy. Klasse!</label>
                    <br />
                    <br />
                    <br />              
                    <label>Dein Median liegt insgesamt bei nur</label>
                    <label id="labelMedianInsgesamt" style="font-size:xx-large;font-weight:900;color:darkgreen;">200 Sekunden</label>
                    <br />
                    <br />
                    <br />
                    <label>Du hast insgesamt</label>
                    <label id="labelInsgesamteAnzahl" style="font-size:xx-large;font-weight:900;color:darkgreen;">50 x </label>
                    <label>gew√ºrfelt!</label>
                    <label>Super gemacht!</label>
                    <br />
                    <br />
                    <br />
                    <br />
                    <br />
                </div>

                <div class="row">
                    <div class="col">
                        <canvas id="diagrammStreuung"></canvas>
                    </div>
                    <div class="col">
                        <canvas id="diagramAnzahlJeKw"></canvas>
                    </div>
                </div>
            </div>           
        </div>
    </body>
</html>



